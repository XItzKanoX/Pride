package net.ccbluex.liquidbounce.features.module.modules.exploit

import me.utils.PacketUtils
import net.ccbluex.liquidbounce.api.minecraft.network.play.client.ICPacketEntityAction
import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.injection.backend.unwrap
import net.ccbluex.liquidbounce.utils.timer.MSTimer
import net.ccbluex.liquidbounce.value.BoolValue
import net.ccbluex.liquidbounce.value.ListValue
import net.minecraft.network.play.client.CPacketConfirmTransaction
import net.minecraft.network.play.client.CPacketEntityAction
import net.minecraft.network.play.client.CPacketKeepAlive
import net.minecraft.network.play.client.CPacketPlayer
import net.minecraft.network.play.server.SPacketPlayerPosLook
import org.apache.commons.lang3.RandomUtils

@ModuleInfo(name = "Disabler", description = "Anti 欣欣.", category = ModuleCategory.EXPLOIT)
class LZQDisabler: Module() {
    val modeValue = ListValue("Mode", arrayOf("HuaYuTing", "Hypixel"), "HuaYuTing")
    private val hypStrafeValue = BoolValue("Hypixel-StrafeTest", true)
    private val hytMoveValue = BoolValue("HYT-Move", true)
    private val hytTimerValue = BoolValue("HYT-Timer", true)
    private val hytScaffoldValue = BoolValue("HYT-Scaffold", true)
    private val hytCombatValue = BoolValue("HYT-Combat", true)
    private val hytBlinkTestValue = BoolValue("HYT-BlinkTest", false)
    private val hytLagValue = BoolValue("HYT-S08Silent", false)

    private var attackPackets = arrayListOf<CPacketPlayer>()
    private var movePackets = arrayListOf<CPacketConfirmTransaction>()
    private var timerPackets = HashMap<CPacketKeepAlive, Int>()
    val msTimer: MSTimer = MSTimer()

    @EventTarget
    fun onUpdate(event: UpdateEvent) {
        if (movePackets.size >= 4) {
            for (packet in movePackets) {
                PacketUtils.sendPacketNoEvent(packet)
            }
            movePackets.clear()
        }

        for (packet in timerPackets) {
            if (msTimer.hasTimePassed(packet.value.toLong())) {
                PacketUtils.sendPacketNoEvent(packet.key)
                timerPackets.remove(packet.key)
                msTimer.reset()
            }
        }

        if (attackPackets.size >= 5) {
            for (packet in attackPackets) {
                PacketUtils.sendPacketNoEvent(packet)
            }
            attackPackets.clear()
        }
    }

    @EventTarget
    fun onPacket(event: PacketEvent) {
        val packet = event.packet.unwrap()

        if (packet is CPacketConfirmTransaction) {
            if (modeValue.get() == "HuaYuTing" && hytMoveValue.get()) if (!PacketUtils.handleSendPacket(packet)) movePackets.add(packet)
            if (modeValue.get() == "Hypixel" && hypStrafeValue.get()) if (!PacketUtils.handleSendPacket(packet)) movePackets.add(packet)
        }

        if (packet is CPacketKeepAlive) {
            if (modeValue.get() == "HuaYuTing" && hytTimerValue.get()) if (!PacketUtils.handleSendPacket(packet)) timerPackets[packet] =
                RandomUtils.nextInt(400, 500)
        }

        if (packet is SPacketPlayerPosLook) {
            if (modeValue.get() == "HuaYuTing" && hytLagValue.get()) {
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y, packet.z, packet  .yaw    , packet.pitch, mc.thePlayer!!.onGround))
                event.cancelEvent()
            }
        }

        if (packet is CPacketPlayer.Position) {
            if (modeValue.get() == "HuaYuTing" && hytBlinkTestValue.get()) {
                mc.netHandler.addToSendQueue(classProvider.createCPacketEntityAction(mc.thePlayer!!, ICPacketEntityAction.WAction.START_SNEAKING))
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y, packet.z, mc.thePlayer!!.rotationYaw, mc.thePlayer!!.rotationPitch, mc.thePlayer!!.onGround))
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y + 1E7, packet.z, mc.thePlayer!!.rotationYaw, mc.thePlayer!!.rotationPitch, mc.thePlayer!!.onGround))
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y - 1E8, packet.z, mc.thePlayer!!.rotationYaw, mc.thePlayer!!.rotationPitch, mc.thePlayer!!.onGround))
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y - 0.000001, packet.z, mc.thePlayer!!.rotationYaw, mc.thePlayer!!.rotationPitch, mc.thePlayer!!.onGround))
                mc.netHandler.addToSendQueue(classProvider.createCPacketPlayerPosLook(packet.x, packet.y, packet.z, mc.thePlayer!!.rotationYaw, mc.thePlayer!!.rotationPitch, mc.thePlayer!!.onGround))
                mc.netHandler.addToSendQueue(classProvider.createCPacketEntityAction(mc.thePlayer!!, ICPacketEntityAction.WAction.STOP_SNEAKING))
            }
        }

        if (packet is CPacketPlayer) {
            if (!PacketUtils.handleSendPacket(packet) && modeValue.get() == "HuaYuTing" && hytCombatValue.get()) {
                attackPackets.add(packet)
            }
        }

        if (packet is CPacketEntityAction && (packet as CPacketEntityAction).action == CPacketEntityAction.Action.START_SPRINTING || (packet as CPacketEntityAction).action == CPacketEntityAction.Action.STOP_SPRINTING) {
            event.cancelEvent()
        }
    }
}